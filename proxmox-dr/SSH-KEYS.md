# SSH Key Strategy

## Overview

The deployment script uses two SSH keys with clear separation of concerns:

```
~/.ssh/
├── homelab_admin          # Your personal admin key (with passphrase)
├── homelab_admin.pub      # Public key for your access
├── homelab_control        # Automation key (no passphrase)
├── homelab_control.pub    # Public key for Terraform/Ansible
└── config                 # SSH config (auto-generated)
```

## Key Purposes

### 1. homelab_admin (Personal Key)

**Purpose:** Your personal administrative access to all systems

**Used for:**
- SSH from your workstation to Proxmox host
- SSH from your workstation to Control VM
- SSH from your workstation to any VM you deploy
- Manual administrative tasks

**Security:**
- **Protected with passphrase** (recommended)
- Use ssh-agent for convenience
- macOS Keychain integration available

**Deployment:**
- Automatically generated by `deploy.sh` if not found
- Automatically copied to Proxmox host
- Automatically added to Control VM during creation

### 2. homelab_control (Automation Key)

**Purpose:** Terraform/Ansible automation from Control VM

**Used for:**
- Control VM → Application VMs (via Terraform)
- Control VM → Application VMs (via Ansible)
- Automated configuration management
- CI/CD pipelines

**Security:**
- **No passphrase** (required for automation)
- Only stored on Control VM
- Only used for VM-to-VM communication
- Never used from your workstation

**Deployment:**
- Optionally generated by `deploy.sh`
- Can be created manually later when needed
- Will be configured when you set up Terraform/Ansible

## Automatic Setup Flow

When you run `./deploy.sh`, the script will:

1. **Check for homelab_admin key**
   - If not found: Prompt to generate it
   - If found: Validate permissions and use it

2. **Prompt for SSH key deployment**
   - Test if key already works with Proxmox
   - If not: Offer to copy it (requires password once)
   - After deployment: Test key-based auth

3. **Generate automation key** (optional)
   - Non-blocking if generation fails
   - Can be created later when needed

4. **Create SSH config**
   - Adds `proxmox` and `control-vm` aliases
   - Configures connection parameters
   - Makes SSH connections easier

## Usage After Setup

### Connect to Proxmox

```bash
# Using alias (from ~/.ssh/config)
ssh proxmox

# Or full command
ssh root@<proxmox-ip>
```

### Connect to Control VM

```bash
# Using alias
ssh control-vm

# Or full command
ssh admin@<control-vm-ip>
```

### SSH Agent (Recommended)

To avoid entering your passphrase repeatedly:

```bash
# macOS: Add to Keychain (permanent)
ssh-add --apple-use-keychain ~/.ssh/homelab_admin

# Linux/Mac: Add to agent (session-based)
ssh-add ~/.ssh/homelab_admin
```

## Manual Key Generation

If you prefer to generate keys manually:

```bash
# Personal admin key (with passphrase)
ssh-keygen -t ed25519 -C "homelab-admin@$(hostname)" -f ~/.ssh/homelab_admin

# Automation key (no passphrase)
ssh-keygen -t ed25519 -C "homelab-control-vm" -f ~/.ssh/homelab_control -N ""

# Copy to Proxmox
ssh-copy-id -i ~/.ssh/homelab_admin.pub root@<proxmox-ip>
```

## Key Distribution Architecture

```
┌─────────────────────────────────────┐
│ Your Workstation                    │
│                                      │
│ ~/.ssh/homelab_admin (private) ──┐  │
│ ~/.ssh/homelab_admin.pub          │  │
│ ~/.ssh/homelab_control (private)  │  │
│ ~/.ssh/homelab_control.pub        │  │
└───────────────────────────────────┘  │
                                       │
                    Personal access    │
                    via homelab_admin  │
                                       │
         ┌─────────────────────────────┘
         │
         ▼
┌─────────────────────────────────────┐
│ Proxmox Host                        │
│                                      │
│ /root/.ssh/authorized_keys:         │
│   - homelab_admin.pub ✓             │
└─────────────────────────────────────┘
         │
         │ DR script copies homelab_admin.pub
         │ during VM creation
         ▼
┌─────────────────────────────────────┐
│ Control VM                          │
│                                      │
│ /home/admin/.ssh/authorized_keys:   │
│   - homelab_admin.pub ✓             │
│                                      │
│ Later: Copy homelab_control here    │
│ for Terraform/Ansible automation    │
└─────────────────────────────────────┘
         │
         │ Terraform/Ansible uses
         │ homelab_control to deploy
         ▼
┌─────────────────────────────────────┐
│ Application VMs (future)            │
│                                      │
│ ~/.ssh/authorized_keys:             │
│   - homelab_admin.pub ✓             │
│   - homelab_control.pub ✓           │
└─────────────────────────────────────┘
```

## Security Best Practices

1. **Always use a passphrase** for homelab_admin
2. **Use ssh-agent** to avoid typing passphrase repeatedly
3. **Never commit private keys** to git (already in .gitignore)
4. **Restrict key permissions:**
   ```bash
   chmod 700 ~/.ssh
   chmod 600 ~/.ssh/homelab_admin
   chmod 600 ~/.ssh/homelab_control
   chmod 644 ~/.ssh/*.pub
   chmod 600 ~/.ssh/config
   ```

5. **Key rotation:** Regenerate keys periodically (e.g., yearly)
6. **Backup keys:** Store encrypted backup of homelab_admin in password manager
